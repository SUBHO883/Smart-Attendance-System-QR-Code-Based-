<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Attendance Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f3f4f6; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Student Attendance</h1>
    </header>

    <!-- Registered Students -->
    <section class="mb-8 bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">Registered Students</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            </tr>
          </thead>
          <tbody id="studentListBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>

    <!-- Attendance Records -->
    <section class="bg-white p-6 rounded shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">All Attendance Records</h2>
        <button id="downloadBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
          Download All Attendance CSV
        </button>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto border border-gray-200 rounded">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
            </tr>
          </thead>
          <tbody id="attendanceBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
  // Load all attendance records from localStorage
  let attendanceRecords = JSON.parse(localStorage.getItem("attendanceRecords")) || [];

  const studentListBody = document.getElementById("studentListBody");
  const attendanceBody = document.getElementById("attendanceBody");

  // --- Populate Registered Students Table ---
  studentListBody.innerHTML = "";
  if(attendanceRecords.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="2" class="px-6 py-4 text-center text-gray-500">No student logged in yet.</td>`;
    studentListBody.appendChild(tr);
  } else {
    const uniqueStudents = [];
    // Only unique students by ID
    attendanceRecords.forEach(record => {
      if(!uniqueStudents.find(s => s.id === record.id)){
        uniqueStudents.push(record);
      }
    });
    uniqueStudents.reverse().forEach(record => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.name}</td>
      `;
      studentListBody.appendChild(tr);
    });
  }

  // --- Populate Attendance Records Table ---
  attendanceBody.innerHTML = "";
  if(attendanceRecords.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="px-6 py-4 text-center text-gray-500">No attendance records found.</td>`;
    attendanceBody.appendChild(tr);
  } else {
    attendanceRecords.slice().reverse().forEach(record => {
      const date = new Date(record.timestamp);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.email || ''}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${date.toLocaleDateString()}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${date.toLocaleTimeString()}</td>
      `;
      attendanceBody.appendChild(tr);
    });
  }

  // --- CSV Download ---
  document.getElementById("downloadBtn").addEventListener("click", () => {
    if(attendanceRecords.length === 0){
      alert("No attendance records to download.");
      return;
    }
    const csvHeader = "Student ID,Name,Email,Date,Time\n";
    const csvRows = attendanceRecords.map(record => {
      const date = new Date(record.timestamp);
      return `${record.id || ''},${record.name || ''},${record.email || ''},${date.toLocaleDateString()},${date.toLocaleTimeString()}`;
    });
    const csvContent = "data:text/csv;charset=utf-8," + csvHeader + csvRows.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `attendance_${new Date().toISOString().split("T")[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
  });
</script>
</body>
</html>
